import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from collections import defaultdict

# ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª
TOKEN = '6752548121:AAF4nLxpFPTQYkszKYObzr4r98HWNDqz8OE'

# Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ù…ÙˆØ¬ÛŒâ€ŒÙ‡Ø§
packages = {
    "1": {
        "name": "Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ ØµÙØ± ØªØ§ ØµØ¯ ØªØ±ÛŒØ¯",
        "description": "ğŸ“Š ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ ØµÙØ± ØªØ§ ØµØ¯ ØªØ±ÛŒØ¯.",
        "price": "ğŸ’µ 200,000 ØªÙˆÙ…Ø§Ù†"
    },
    "2": {
        "name": "Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆØ±Ø¯",
        "description": "ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆØ±Ø¯.",
        "price": "ğŸ’µ 150,000 ØªÙˆÙ…Ø§Ù†"
    },
    "3": {
        "name": "Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ù¾Ø§ÙˆØ±Ù¾ÙˆÛŒÙ†Øª",
        "description": "ğŸ“Š ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ù¾Ø§ÙˆØ±Ù¾ÙˆÛŒÙ†Øª.",
        "price": "ğŸ’µ 180,000 ØªÙˆÙ…Ø§Ù†"
    },
    "4": {
        "name": "Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± Ø¨Ø±Ø§ÛŒ Ú©ÙˆØ¯Ú©Ø§Ù†",
        "description": "ğŸ‘¶ğŸ’» ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± Ø¨Ø±Ø§ÛŒ Ú©ÙˆØ¯Ú©Ø§Ù†.",
        "price": "ğŸ’µ 100,000 ØªÙˆÙ…Ø§Ù†"
    },
    "5": {
        "name": "Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø²Ø¨Ø§Ù† Ø¢Ù„Ù…Ø§Ù†ÛŒ",
        "description": "ğŸ‡©ğŸ‡ª ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø²Ø¨Ø§Ù† Ø¢Ù„Ù…Ø§Ù†ÛŒ.",
        "price": "ğŸ’µ 250,000 ØªÙˆÙ…Ø§Ù†"
    }
}

# Ù„ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡
card_numbers = [
    {"number": "1234-5678-9012-3456", "ali": "Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø§ÙˆÙ„"},
    {"number": "2345-6789-0123-4567", "reza": "Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¯ÙˆÙ…"},
    # Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ± Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
]

card_usage_count = defaultdict(int)

# ØªØ§Ø¨Ø¹ Ø§Ø³ØªØ§Ø±Øª
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    welcome_message = "Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¢Ú©Ø§Ø¯Ù…ÛŒ Ø´Ú©Ø±ÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! ğŸ‘‹"
    await update.message.reply_text(welcome_message)

    keyboard = [
        [InlineKeyboardButton("ğŸ“Š Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ ØµÙØ± ØªØ§ ØµØ¯ ØªØ±ÛŒØ¯", callback_data='1')],
        [InlineKeyboardButton("ğŸ“ Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ ÙˆØ±Ø¯", callback_data='2')],
        [InlineKeyboardButton("ğŸ“Š Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ù¾Ø§ÙˆØ±Ù¾ÙˆÛŒÙ†Øª", callback_data='3')],
        [InlineKeyboardButton("ğŸ‘¶ğŸ’» Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± Ø¨Ø±Ø§ÛŒ Ú©ÙˆØ¯Ú©Ø§Ù†", callback_data='4')],
        [InlineKeyboardButton("ğŸ‡©ğŸ‡ª Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø²Ø¨Ø§Ù† Ø¢Ù„Ù…Ø§Ù†ÛŒ", callback_data='5')],
        [InlineKeyboardButton("en Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ", callback_data='6')],
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=reply_markup)

# ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ú©ÛŒØ¬
async def package_details(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    package_id = query.data

    package = packages.get(package_id, {})
    details_message = f"Ù†Ø§Ù… Ù¾Ú©ÛŒØ¬: {package.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\n\n{package.get('description', 'ØªÙˆØ¶ÛŒØ­Ø§Øª Ù†Ø§Ù…Ø´Ø®Øµ')}\n\nÙ‚ÛŒÙ…Øª: {package.get('price', 'Ù‚ÛŒÙ…Øª Ù†Ø§Ù…Ø´Ø®Øµ')}"

    await query.message.reply_text(details_message)

    # Ø¯Ú©Ù…Ù‡ Ø®Ø±ÛŒØ¯
    buy_keyboard = [
        [InlineKeyboardButton("ğŸ›’ Ø®Ø±ÛŒØ¯ Ù¾Ú©ÛŒØ¬", callback_data=f'buy_{package_id}')]
    ]
    reply_markup = InlineKeyboardMarkup(buy_keyboard)
    await query.message.reply_text("Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ù¾Ú©ÛŒØ¬ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:", reply_markup=reply_markup)

# ØªØ§Ø¨Ø¹ Ø®Ø±ÛŒØ¯ Ù¾Ú©ÛŒØ¬
async def buy_package(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    package_id = query.data.split('_')[1]

    # Ø§Ø±Ø³Ø§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø¨Ø§ Ù†Ø§Ù…
    card_buttons = [
        [InlineKeyboardButton(f"{card['ali']} - {card['number']}", callback_data=f'card_{i}')] for i, card in enumerate(card_numbers)
    ]

    card_keyboard = InlineKeyboardMarkup(card_buttons)
    await query.message.reply_text("ğŸ’³ Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯:", reply_markup=card_keyboard)

    # Ù¾ÛŒØ§Ù… Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯
    await query.message.reply_text("ğŸ“¤ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")

    # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø±
    context.user_data['awaiting_receipt'] = package_id

# ØªØ§Ø¨Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª
async def select_card(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    card_index = int(query.data.split('_')[1])

    # Ø§ÙØ²Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª
    card_usage_count[card_index] += 1

    # Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª
    if card_usage_count[card_index] > 5:
        await query.message.reply_text("â—ï¸ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
        await query.message.reply_text("ğŸ”§ Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ØªØ§ Ø³Ø§Ø¹Ø§ØªÛŒ Ø¯ÛŒÚ¯Ø± ØµØ¨Ø± Ú©Ù†ÛŒØ¯.")

        # Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ù…Ø¯ÛŒØ± (Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¯ÛŒØ± Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ú¯ÛŒØ±Ø¯)
        # Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¨Ù‡ Ù…Ø¯ÛŒØ±
        # Ù…Ø¯ÛŒØ± Ø¨Ø§ÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø±ÙˆØ² Ú©Ù†Ø¯

        return

    await query.message.reply_text(f"Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {card_numbers[card_index]['number']}")

# ØªØ§Ø¨Ø¹ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø³ÛŒØ¯
async def handle_receipt(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if 'awaiting_receipt' in context.user_data:
        package_id = context.user_data['awaiting_receipt']
        receipt_photo = update.message.photo[-1]  # Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¹Ú©Ø³
        receipt_id = update.message.message_id

        # Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø±Ø³ÛŒØ¯
        manager_chat_id = '7304354618:AAGaYSXeBLFW_zPnbo3gW_oMOQz86CmjF4k'
        await context.bot.send_message(
            manager_chat_id,
            f"Ø±Ø³ÛŒØ¯ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {update.message.from_user.id} Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.\nØ´Ù†Ø§Ø³Ù‡ Ø±Ø³ÛŒØ¯: {receipt_id}",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton(f"ØªØ§ÛŒÛŒØ¯ Ø±Ø³ÛŒØ¯ {receipt_id}", callback_data=f'approve_{receipt_id}')]
            ])
        )

        # Ù¾ÛŒØ§Ù… ØªØ§ÛŒÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø³ÛŒØ¯ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        await update.message.reply_text("Ø±Ø³ÛŒØ¯ Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³Øª. âœ…")
        del context.user_data['awaiting_receipt']
    else:
        await update.message.reply_text("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù¾Ú©ÛŒØ¬ Ø±Ø§ Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.")

def main() -> None:
    application = Application.builder().token(TOKEN).build()

    # Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(package_details, pattern='^[1-6]$'))
    application.add_handler(CallbackQueryHandler(buy_package, pattern='^buy_'))
    application.add_handler(CallbackQueryHandler(select_card, pattern='^card_'))
    application.add_handler(MessageHandler(filters.PHOTO | filters.Document.ALL, handle_receipt))

    # Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª
    loop = asyncio.get_event_loop()
    try:
        loop.run_until_complete(application.run_polling())
    finally:
        loop.close()

if __name__ == '__main__':
    main()
